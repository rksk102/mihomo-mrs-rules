name: "Build MRS from TXT"

on:
  push:
    branches: [ main ]
    paths:
      - 'rulesets/**'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: build-mrs
  cancel-in-progress: true

env:
  # 可选：填入你认可的 tools/mrs-generator 的 SHA256，开启完整性校验
  MRS_GEN_SHA256: ""  # 例如: "abcd1234..."; 留空则不校验

jobs:
  build-mrs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Verify tool exists (and integrity if configured)
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -x "tools/mrs-generator" ]; then
            echo "::error::tools/mrs-generator not found or not executable."
            echo "提示：先在 Actions 运行 'Get mrs-generator (via Go proxy)'，或手动上传 tools/mrs-generator。"
            exit 1
          fi
          if [ -n "${MRS_GEN_SHA256}" ]; then
            echo "Verifying tools/mrs-generator SHA256..."
            calc=$(sha256sum tools/mrs-generator | awk '{print $1}')
            if [ "$calc" != "${MRS_GEN_SHA256}" ]; then
              echo "::error::SHA256 mismatch! expected=${MRS_GEN_SHA256}, got=${calc}"
              exit 1
            fi
          fi

      - name: Convert TXT to MRS
        shell: bash
        run: |
          set -euo pipefail
          find rulesets -type f -name "*.txt" | while read -r in_file; do
            out_file=$(echo "$in_file" | sed 's|^rulesets/|mrs-rules/|' | sed 's|\.txt$|.mrs|')
            echo "Converting: $in_file  ==>  $out_file"
            mkdir -p "$(dirname "$out_file")"
            ./tools/mrs-generator -i "$in_file" -o "$out_file"
          done

      - name: Commit and Push MRS files
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z $(git status --porcelain mrs-rules) ]]; then
            echo "No changes to MRS files. Nothing to commit."
            exit 0
          fi
          git config user.name 'GitHub Actions Bot'
          git config user.email 'actions@github.com'
          git add mrs-rules/
          git commit -m "chore(mrs): Auto-build MRS files"
          git push
