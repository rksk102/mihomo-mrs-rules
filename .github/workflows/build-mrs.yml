name: "Build MRS from TXT"

on:
  push:
    branches: [ main ]
    paths:
      - 'rulesets/**'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: build-mrs
  cancel-in-progress: true

jobs:
  build-mrs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 可选：缓存工具，减少每次拉取
      - name: Cache mrs-generator
        uses: actions/cache@v4
        with:
          path: tools/mrs-generator
          key: mrs-generator-bin-${{ runner.os }}

      - name: Setup Go (for fallback install)
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      # 兜底：如果 tools/mrs-generator 不存在，则尝试通过 Go 代理安装
      - name: Ensure mrs-generator present
        shell: bash
        env:
          GOPROXY: https://proxy.golang.org,direct
        run: |
          set -euo pipefail
          if [ -x "tools/mrs-generator" ]; then
            echo "Using existing tools/mrs-generator"
            exit 0
          fi

          echo "tools/mrs-generator not found, trying to install via Go proxy..."
          go version

          candidates=(
            "github.com/MetaCubeX/mrs-generator@v1.1.0"
            "github.com/MetaCubeX/mrs-generator@latest"
          )
          ok=""
          for mod in "${candidates[@]}"; do
            echo "Trying: $mod"
            if go install "$mod"; then
              ok="$mod"
              break
            fi
          done
          if [ -z "$ok" ]; then
            echo "::warning::Unable to install mrs-generator from Go proxy. If this persists, please run 'Get mrs-generator' workflow (commit_to_repo=true) or manually upload tools/mrs-generator."
            exit 0
          fi

          BIN="$(go env GOPATH)/bin/mrs-generator"
          if [ -x "$BIN" ]; then
            mkdir -p tools
            cp "$BIN" tools/mrs-generator
            chmod +x tools/mrs-generator
            echo "Installed mrs-generator from $ok"
          else
            echo "::warning::Installed binary not found at $BIN"
          fi

      - name: Convert TXT to MRS
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -x "tools/mrs-generator" ]; then
            echo "::error::tools/mrs-generator not found or not executable. Please run 'Get mrs-generator' workflow or upload tools/mrs-generator."
            exit 1
          fi

          find rulesets -type f -name "*.txt" | while read -r in_file; do
            out_file=$(echo "$in_file" | sed 's|^rulesets/|mrs-rules/|' | sed 's|\.txt$|.mrs|')
            echo "Converting: $in_file  ==>  $out_file"
            mkdir -p "$(dirname "$out_file")"
            ./tools/mrs-generator -i "$in_file" -o "$out_file"
          done

      - name: Commit and Push MRS files
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z $(git status --porcelain mrs-rules) ]]; then
            echo "No changes to MRS files. Nothing to commit."
            exit 0
          fi
          git config user.name 'GitHub Actions Bot'
          git config user.email 'actions@github.com'
          git add mrs-rules/
          git commit -m "chore(mrs): Auto-build MRS files"
          git push
