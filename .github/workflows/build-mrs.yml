name: "Build MRS from TXT (Auto-Download Tool)"

on:
  push:
    branches: [ main ]
    paths:
      - 'rulesets/**'
  
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: build-mrs
  cancel-in-progress: true

jobs:
  build-mrs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download and Setup mrs-generator
        shell: bash
        run: |
          echo "Downloading mrs-generator directly from GitHub..."
          mkdir -p tools
          
          # 【重要修改】不再使用 ghproxy.com，直接从 GitHub 下载
          curl -L -o tools/mrs-generator.tar.gz "https://github.com/zYx-Tom/mrs-generator/releases/download/v1.1.0/mrs-generator-linux-amd64.tar.gz"
          
          echo "Extracting tool..."
          tar -xzf tools/mrs-generator.tar.gz -C tools/
          
          chmod +x tools/mrs-generator
          echo "mrs-generator is ready."

      - name: Convert TXT to MRS
        shell: bash
        run: |
          find rulesets -type f -name "*.txt" | while read -r in_file; do
            out_file=$(echo "$in_file" | sed 's|^rulesets/|mrs-rules/|' | sed 's|\.txt$|.mrs|')
            echo "Converting: $in_file  ==>  $out_file"
            mkdir -p "$(dirname "$out_file")"
            ./tools/mrs-generator -i "$in_file" -o "$out_file"
          done

      - name: Commit and Push MRS files
        run: |
          if [[ -z $(git status --porcelain mrs-rules) ]]; then
            echo "No changes to MRS files. Nothing to commit."
            exit 0
          fi
          
          git config user.name 'GitHub Actions Bot'
          git config user.email 'actions@github.com'
          git add mrs-rules/
          git commit -m "chore(mrs): Auto-build MRS files"
          git push
